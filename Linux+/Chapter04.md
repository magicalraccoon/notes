# Devices, Linux Filesystems, and the Filesystem Hierarchy Standard
## Create Partitions and Filesystems
MBR can support up to four partitions:
- One secondary, Three primaries.
- Only supports drives up to 2TB.

Troubleshooting starts with fdisk
  `sudo fdisk /dev/sda`
  If a drive is listend with an asterix, it is a boot partition.
  - A linux partition type is 83
  - An extended partition type is 5
  - A linux swap partition type is 82

To manage partitions on a GPT drive, use `parted` or `gdisk`.

A new partition needs to be formatted:
  - `sudo mkfs -t ext4 /dev/sdc1` will set up sdc1 as an ext4 filesystem.

A swap partition can be made with `sudo mkswap /dev/sdb2`.

Reiserfs will need to be formatted with `sudo mkreiserfs /dev/sdb1`.

**Descriptions of modern popular filesystems:**
  - ext2 (extended): No journaling (recording changes to improve crash recovery).
  - ext4: Journaling with file support up to 16TB.
  - reiserfs: Journaled and stable.
  - btrfs: Extremely stable.
  - XFS: 64-bit journaled filesystem for large filesystems.
  - VFAT: An extension of FAT32. Compatable with Windows.

## Maintain the Integrity of Filesystems
### Monitoring
- `df -h` will return all partitions in human readable terms.

- `df -i` will return all partition usage by inode.
  - An inode is a data structure containing the attributes and the disk block location of a file or directory.

- `du` will display how much disk space is being used by a specific directory.

- `du -s` will display the total size.

### Preventive Maintenance
Check out `tune2fs`!
  - `sudo tune2fs -c 40 -i 1m /dev/sda1`.
    - `-c 40` sets the maximum mounts.
    - `-i 1m` sets the interval to one month.
  - `sudo tune2fs -j /dev/sda1` will add a journal.
  - `sudo tune2fs -L new_name /dev/sda1` will allow you to change the label name.

### Repair
1. Unmount a drive with `sudo umount /dev/sdc`.
2. Run fsck with `sudo fsck /dev/sdc1`.
3. You can let fsck automatically fix some errors with `e2fsk -p /dev/sda1`.
4. `sudo debugfs /dev/sda1` will place you into a new shell. Use `?` to open a menu.

## Control Mounting and Unmounting of Filesystems
It's traditional to mount devices to directories in /mnt or /media, but you can mount wherever.

Example:
  - From inside of /media, `sudo mkdir newdrive` to make a new mount point.
  - `lsblk` to list all block devices plugged in.
  - Mount the drive with `sudo mount /dev/sdc1 /media/newdrive`
  - Once you're done, unmount with `sudo unmount /dev/sdc1`

The `/etc/fstab` file contains a mounting list. Drives will be automatically mounted on boot.
  - To find a devices's UUID, run `blkid /dev/sda1`.

## Manage Disk Quotas
System disk space can be limited with the `quota` program.

In order to manage quotas, you'll need to add `,usrquota,grpquota` to your /etc/fstab file.

The next time you reboot your computer or run `sudo mount -a`, your new setting will be enabled.

You'll need to build a table containing current disk usage by running `sudo quotacheck -avmug`.

To turn on quota checking, you'll need to run `sudo quotaon -av`.

A quota report may be generated by using `sudo repquota -av`

When you first use quota, you'll need to edit the settings like `sudo edquota -u <username>` for users, or `edquota -g <groupname>` for groups.

You can set a soft limit with `sudo edquota -t`.

## Manage File Permissions and Ownership
Each object in a Linux filesystem has an owner and a group, and rules that determine who and what gets access.    

### Letters
    Code        Permission
     r           Read
     W           Write
     X           Execute

    Code        Subject
     u           User (object owner)
     g           Group
     o           Other (all other users)

To add write permissions to a file for all users, run `chmod o+w myfile.txt`.

Likewise you can remove permissions from a group with `chmod g-r myfile.txt`.

You can see a list of a file's property with `ls -l | grep myfile`.

--

To change a file's owner and group, you can use `sudo chown steve:steve myfile.txt`. Add an `-R` for directories.
  - owner:group

### Numbers (octal)
    Value       Permission
     4           Read
     2           Write
     1           Execute

Similarly, `chmod 664 myfile.txt` will allow read and write powers to the user and group, but only read to others.

### Umask
Umasks are derived from octals. In order to get a file's umask, first start with a 0. Then subtract the octal notation from the previous section from 7. The umask of 751 would be 0026.

Whenever the current user creates a new object, it will automatically be given the value of 0002.

### Using suid, sgid, and the Sticky Bit
  - `suid` will set owner User ID, and elevates any user who executes a file to the status of owner, only for as long as it is executing. (ex: the passwd file)

    - A file's suid can be added to executable files by using `sudo chmod u+s myexecutable`.
    - You can also add sgid to groups with `sudo chmod g+s yourexecutable`.
      - All subfiles and subdirectories will inherit the group ownership from the parent directory.

  - Sticky bits can be applied to directories in order to protect files within from being deleted by other users.
    - `sudo chmod +t ourfiles`

## Create and Change Hard and Symbolic Links
Symbolic links can be made pretty much anywhere.

Hard links - share an inode (they are the same file).
  - Creating a hard link like so: `ln ~/stuff1.txt ~/files` will place a link to stuff1.txt in ~/files.

Soft (symbolic) links are created like `ln -s /stuff1.txt ~/files`.
  - Checking `ls -l` on that file will reveal that the file is linked, and where it is linked to. A letter l will be displayed as well.

## Find System Files and Place Files in the Correct Location
### Filesystem Hierarchy Standard (FHS)
In the root directory, there are seven standardized directories:

    /bin      Core system executables and shells
    /dev      Hardware devices
    /etc      Text-based config files
    /home     User home subdirectories
    /lib      Code libraries
    /usr      Application files
    /var      Variable data including logs

There are others too!

    /boot     Bootloader files
    /media    Place to mount external devices
    /mnt      Alternative location for mounting external drives
    /opt      Program installation files
    /proc     Psuedo filesystem representing processes
    /root     Root user's home directory
    /run      Runtime data storage
    /sbin     Admin binaries
    /srv      Site-specific data
    /sys      System hardware info
    /tmp      Temp system files

### Search Tools
- Search for files with the `find` command. For example, `sudo find /etc/ -name *.conf` will search /etc for filenames ending in .conf.

- The `locate` command will browse a directory's index. You'll need to manually update the index with `sudo updatedb` though.

- If you know the name of a binary file, you can locate it with `whereis ls`, where ls is the binary you want to find.

- You can also use `which ls` to list the location of ls.

- Also, `type ls` will identify any aliases associated with ls.

--
## Test Yourself
1. Which of the following filesystems is NOT journaled:
  - c. ext2

2. What will selecting "p" accomplish in fdisk?
  - a. List current partitions

3. Which of the following commands will display the total size taken up by specified directories and their files?
  - d. du -s

4. Which of these will successfully mount the drive called sdc1?
  - b. sudo mount /dev/sdc1 newdrive

5. To which file must you add ,usrquota,grpquota to ensure quota will run?
  - a. /etc/fstab

6. What is the correct octal value of a text file that was created by a user with the umask 0022?
  - b. 644

7. What is the octal value that corresponds to -rwxrw-r--?
  - c. 764

8. You can create a symbolic link to the cp binary file using:
  - a. ls -s /bin/cp ~/

9. Which of the following directories contains text-based config files?
  - c. /etc

10. Which of the following will find the location of any file the quickest?
  - c. locate
